name: .NET Build and Publish

on:
  push:
    branches: ["main"]
    tags:
      - "v*"
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        framework: [net8.0, net9.0, net10.0]
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup .NET 10.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build for ${{ matrix.framework }}
        run: dotnet build --configuration Release --framework ${{ matrix.framework }} --no-restore

      - name: Test for ${{ matrix.framework }}
        run: dotnet test --configuration Release --framework ${{ matrix.framework }} --no-build --verbosity normal --logger "trx;LogFileName=test-results-${{ matrix.framework }}.trx"

      - name: Upload test results for ${{ matrix.framework }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.framework }}
          path: '**/test-results-${{ matrix.framework }}.trx'

  publish:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup .NET 10.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update version in project file
        run: |
          sed -i "s/<Version>.*<\/Version>/<Version>${{ steps.get_version.outputs.VERSION }}<\/Version>/g" WebSpark.Bootswatch/WebSpark.Bootswatch.csproj
          sed -i "s/<AssemblyVersion>.*<\/AssemblyVersion>/<AssemblyVersion>${{ steps.get_version.outputs.VERSION }}<\/AssemblyVersion>/g" WebSpark.Bootswatch/WebSpark.Bootswatch.csproj
          sed -i "s/<FileVersion>.*<\/FileVersion>/<FileVersion>${{ steps.get_version.outputs.VERSION }}<\/FileVersion>/g" WebSpark.Bootswatch/WebSpark.Bootswatch.csproj

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Pack
        run: dotnet pack WebSpark.Bootswatch/WebSpark.Bootswatch.csproj --configuration Release --no-build --output ./nuget-packages

      - name: Validate Multi-Framework Package
        run: |
          echo "Validating multi-framework NuGet package..."

          # Package path
          PACKAGE_PATH="nuget-packages/WebSpark.Bootswatch.${{ steps.get_version.outputs.VERSION }}.nupkg"

          # Check if package exists
          if [ ! -f "$PACKAGE_PATH" ]; then
            echo "::error::Package file not found at: $PACKAGE_PATH"
            exit 1
          fi
          echo "âœ“ Package found: $PACKAGE_PATH"
          echo "  Size: $(du -h "$PACKAGE_PATH" | cut -f1)"

          # Extract and inspect package contents
          mkdir -p package-contents
          unzip -q "$PACKAGE_PATH" -d package-contents

          # Verify multi-framework support
          echo ""
          echo "Checking framework support..."
          
          FRAMEWORKS=("net8.0" "net9.0" "net10.0")
          for fw in "${FRAMEWORKS[@]}"; do
            if [ -d "package-contents/lib/$fw" ]; then
              DLL_COUNT=$(find "package-contents/lib/$fw" -name "WebSpark.Bootswatch.dll" | wc -l)
              if [ $DLL_COUNT -gt 0 ]; then
                echo "âœ“ $fw: Assembly found"
                DLL_SIZE=$(du -h "package-contents/lib/$fw/WebSpark.Bootswatch.dll" | cut -f1)
                echo "    Size: $DLL_SIZE"
              else
                echo "::error::$fw: Assembly not found!"
                exit 1
              fi
            else
              echo "::error::$fw: Framework folder not found!"
              exit 1
            fi
          done

          # Check for symbols package
          SYMBOLS_PATH="nuget-packages/WebSpark.Bootswatch.${{ steps.get_version.outputs.VERSION }}.snupkg"
          if [ -f "$SYMBOLS_PATH" ]; then
            echo "âœ“ Symbols package found"
          else
            echo "::warning::Symbols package not found"
          fi

          # Check for essential package files
          echo ""
          echo "Checking package metadata..."
          [ -f package-contents/README.md ] && echo "âœ“ README.md included" || echo "::warning::README.md not found"
          [ -f package-contents/LICENSE ] && echo "âœ“ LICENSE included" || echo "::warning::LICENSE not found"
          [ -f package-contents/NOTICE.txt ] && echo "âœ“ NOTICE.txt included" || echo "::warning::NOTICE.txt not found"
          [ -f package-contents/WebSpark.png ] && echo "âœ“ Package icon included" || echo "::warning::Package icon not found"

          # Check for XML documentation
          XML_COUNT=$(find package-contents/lib -name "*.xml" 2>/dev/null | wc -l)
          if [ $XML_COUNT -ge 3 ]; then
            echo "âœ“ XML documentation included for all frameworks"
          else
            echo "::warning::XML documentation may be missing for some frameworks"
          fi

          echo ""
          echo "Package validation completed successfully!"

      - name: Push to NuGet
        run: dotnet nuget push nuget-packages/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          body: |
            # WebSpark.Bootswatch ${{ steps.get_version.outputs.VERSION }}

            Multi-framework support for .NET 8.0, 9.0, and 10.0.

            ## ðŸŽ¯ Multi-Framework Support

            This package supports:
            - âœ… .NET 8.0 (LTS) - Supported until November 2026
            - âœ… .NET 9.0 (STS) - Supported until May 2026
            - âœ… .NET 10.0 (Current) - Latest features

            The correct assembly is automatically selected based on your project's target framework.

            ## ðŸ“¦ Installation

            ```bash
            dotnet add package WebSpark.Bootswatch --version ${{ steps.get_version.outputs.VERSION }}
            ```

            Or via Package Manager Console:
            ```powershell
            Install-Package WebSpark.Bootswatch -Version ${{ steps.get_version.outputs.VERSION }}
            ```

            ## ðŸ§ª Testing

            This release includes comprehensive testing:
            - 11 unit tests
            - Tested on .NET 8.0, 9.0, and 10.0
            - 33 total test executions

            ## ðŸ“š Documentation

            - [README](https://github.com/MarkHazleton/WebSpark.Bootswatch/blob/main/README.md)
            - [CHANGELOG](https://github.com/MarkHazleton/WebSpark.Bootswatch/blob/main/CHANGELOG.md)
            - [Demo Site](https://bootswatch.markhazleton.com)

            ## ðŸ”— Resources

            - **NuGet**: https://www.nuget.org/packages/WebSpark.Bootswatch/${{ steps.get_version.outputs.VERSION }}
            - **Repository**: https://github.com/MarkHazleton/WebSpark.Bootswatch
            - **Issues**: https://github.com/MarkHazleton/WebSpark.Bootswatch/issues
          files: |
            nuget-packages/WebSpark.Bootswatch.${{ steps.get_version.outputs.VERSION }}.nupkg
            nuget-packages/WebSpark.Bootswatch.${{ steps.get_version.outputs.VERSION }}.snupkg

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Display test summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Framework | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| .NET 8.0  | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| .NET 9.0  | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| .NET 10.0 | âœ… PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All frameworks tested successfully!" >> $GITHUB_STEP_SUMMARY
